<!DOCTYPE html>
<html>
  <head>
  	<meta charset="utf-8">
  	<title>MAILExcel</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css" >
    <link rel="stylesheet" href="bootstrap/css/bootstrap-responsive.css" >
    <script src="jquery/jquery-2.0.3.js"></script>
	<script src="bootstrap/js/bootstrap.min.js"></script>
  </head>
  <body>
  	
  	<div class="navbar">
	    <div class="navbar-inner">
	        <div class="container">
	            <ul class="nav">
	                <a class="brand" href="#">MAILExcel</a>
	                <li ><a href="mail.html">发送邮件</a></li>
	                <li class="dropdown active" id="accountmenu">
	                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">配置<b class="caret"></b></a>
	                    <ul class="dropdown-menu">
	                        <li><a href="serverinfo.html">服务器</a></li>
	                        <li><a href="userinfo.html">员工邮件</a></li>
	                    </ul>
	                </li> 
	            </ul>
	        </div>
	    </div>
	</div>

	<div class="container">
		<h2>员工邮件</h2> 
		<form class="form-horizontal" >
		  <div class="control-group">
		   <table id="maintab" class="table  table-bordered" style="margin-bottom:5px;">
              <thead>
                <tr>
                  <th>#</th>
                  <th>姓名</th>
                  <th>邮件</th> 
                  <th style="width:30px;">删除</th>     
                </tr>
              </thead>
              <tbody>

              </tbody>
            </table>
		  	<div class="pull-right">
		  		<span class="alert alert-success hide">
	              <strong>成功!</strong> 员工邮件已更新。
	            </span>
		  			<a id="btn_add_row" class="btn btn-small" href="#"><i class="icon-plus"></i></a>
			  		<a id="btn_save"   class="btn btn-small btn-primary" href="#">保存</a>
			</div>
		  	</div>
		  </div>
		</form>
	</div>
	<span id="info"></span>


	<script type="text/javascript" src="lib/handlebars/handlebars-1.0.0.beta.6.js"></script>

	<script id="tr-template" type="text/x-handlebars-template">
    <tr>
     	<td>{{no}}</td>
     	<td><input class="input-small" name="user" type="text"  value="{{user}}"></td>
     	<td><input class="input-large" name="email" type="text" value="{{email}}"></td>
     	<td><a class="btn_remove_row btn btn-small btn-danger" href="#"><i class="icon-minus"></i></a></td>
    </tr>
    </script>
	
	<script type="text/javascript">
	var db= require('./main/tinydb.js');
	var template = Handlebars.compile($("#tr-template").html());

	$(function(){
		var remove_row=function(){
			var tr=$(this).parents("tr:eq(0)");
			tr.remove();
			reIndexTable();
		}

		var copytr=function(data){
			var tr=$(template(data));
			tr.find(".btn_remove_row").click(remove_row);
			return tr;
		};

		db.find("userinfo",function(userinfo){
			if(userinfo&&userinfo.data){
				var tbody=$("#maintab tbody");
				var data=userinfo.data;
				for (var i = 0; i < data.length; i++) {
					tr=copytr(data[i]);
					tbody.append(tr);
				};
			}
		},{});

		function reIndexTable(){
			var tbody=$("#maintab tbody"),index=0;
			tbody.find("tr").each(function(){
				index++;
				$(this).find("td").eq(0).html(index);
			});
		}
		 
		$("#btn_edit").click(function(){
			$("#btn_edit_span").show();
			$(this).hide();
		});
		$("#btn_add_row").click(function(){
			var tbody=$("#maintab tbody");
			var len=tbody.find("tr").size();
			var data={no:len+1};
			tbody.append(copytr(data));
		});

	
		$("#btn_cancle").click(function(){
			$("#btn_edit_span").hide();
			$("#btn_edit").show();
		});
		$("#btn_save").click(function(){
			var tr=$("#maintab tbody tr");
			var data=[];//用户邮件数组
			var index=0;
			tr.each(function(){
				data[index]={
					no:index+1,
					user:$(this).find("input[name=user]").val(),
					email:$(this).find("input[name=email]").val()
				}
				index++;
			});
			db.save("userinfo",{'data':data},function(){
				$('.alert').show();
				setTimeout(function(){$('.alert').hide()},3000);
			});
		});
		
	})	
	</script>
    
	</body>
</html>