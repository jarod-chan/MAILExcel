<!DOCTYPE html>
<html>
  <head>
  	<meta charset="utf-8">
  	<title>MAILExcel</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css" >
    <link rel="stylesheet" href="bootstrap/css/bootstrap-responsive.css" >
    <script src="jquery/jquery-2.0.3.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <style type="text/css">
		.drop_div{
			border:2px dashed #bbb;
			-moz-border-radius:5px;
			-webkit-border-radius:5px;
			border-radius:5px;
			padding:25px;
			text-align:center;
			font:20pt bold,"Vollkorn";
			color:#bbb
		}
		.navbar{
			margin-bottom: 5px;
		}
		.send_div{
			padding-left: 5px;
			padding-right: 5px;
		}
  </style>
  </head>
  <body>
  	
  	<div class="navbar">
	    <div class="navbar-inner">
	        <div class="container">
	            <ul class="nav">
	                <a class="brand" href="#">MAILExcel</a>
	                <li class="active" ><a href="mail.html">发送邮件</a></li>
	                <li class="dropdown" id="accountmenu">
	                    <a class="dropdown-toggle" data-toggle="dropdown" href="#">配置<b class="caret"></b></a>
	                    <ul class="dropdown-menu">
	                        <li><a href="serverinfo.html">服务器</a></li>
	                        <li><a href="userinfo.html">员工邮件</a></li>
	                    </ul>
	                </li> 
	            </ul>
	        </div>
	    </div>
	</div>
	

	<div class="drop_div" id="drop_div" >拖放一个excel(.xls)文件到这里.</div>
	

	<div class="send_div">
		   
		  <div class="control-group">
	  	  	<div class="pull-right">
		  		<button  id="btn_send"   class="btn btn-small btn-primary disabled">发送邮件</button>
			</div>
			<h3 id="title"></h3>
		    <table id="maintab" class="table  table-bordered" >
              <thead>
              </thead>
              <tbody>
              </tbody>
            </table>
		  </div>
	</div>


	<script src="lib/xls/xls.js"></script>
	<script src="lib/handlebars/handlebars-1.0.0.beta.6.js"></script>

	<!-- 邮件模板 -->
	<script id="tab-template" type="text/x-handlebars-template">
	<table style="border-collapse: collapse" border="1" cellspacing="0" bordercolor="#000000">
		<tr>
			<td colspan="{{len}}">{{title}}</td>
		</tr>
		<tr>
			{{#each col}}
		    	<td style="width: 100px">{{this}}</td>
		    {{/each}}
		</tr>
		<tr>
			{{#each row}}
		    	<td style="width: 100px">{{this}}</td>
		    {{/each}}
		</tr>
	</table>
    </script>

	<script>

	var async = require('async');
	var nodemailer = require("nodemailer");
	var db= require('./main/tinydb.js');
	var template = Handlebars.compile($("#tab-template").html());

	$(function(){
		function find_email(emails,name){
			if(!emails) return;
			for (var i = 0; i <emails.length; i++) {
			   if(emails[i].user==name){
			     return emails[i].email;
			   }
			};
		}

		function make_mail_list(sheet,emails){
			var ret=[];
			for(var i in sheet.data){
				var name=sheet.data[i][0];
				var email=find_email(emails,name);
				var item={has_email:false};
				if(email){
					item={
						has_email:true,
						email:email
					}
				}
				ret.push(item);
			}
			return ret;
		}



		function get_mail_data(sheet,mail_list,server_mail){
			var ret=[];
			for (var i = 0; i < mail_list.length; i++) {
				var mail_info=mail_list[i];
				var mail_option={};
				if(mail_info.has_email){
					var dt={
						len:sheet.col.length,
						title:sheet.title,
						col:sheet.col,
						row:sheet.data[i]
					}
					var html=template(dt);
					mail_option={
					    from: server_mail, 
					    to: mail_info.email, 
					    subject: sheet.title, 
					    generateTextFromHTML : true, 
					    html: html
					}
				}

				var mail_data={
					idx:i,
					has_email:mail_info.has_email,
					mail_option:mail_option
				};
				ret.push(mail_data);
			};
			return ret;
		}

		function create_server_porp(sv){
			return {
			    host: sv.host,
			    secureConnection: true, // use SSL
			    port: parseInt(sv.port), // port for secure SMTP
			    auth: {
			        user: sv.email,
			        pass: sv.password
			    }
			};
		}


		$("#btn_send").click(function(){
			var btn_send=$(this);
			if(sheet1){
				if(btn_send.hasClass('disabled')) return;
				btn_send.toggleClass('disabled');
				$("#div_load").show();
				async.series({
				    userinfo: function(cb) {
				    	db.find("userinfo",function(rt){ var err="";cb(err,rt)}) 
				    },
				    serverinfo: function(cb) {
				    	db.find("serverinfo",function(rt){ var err="";cb(err,rt)}) 
				    }
				}, function(err,vals) {
					if(!vals.userinfo || !vals.serverinfo){
						btn_send.removeClass('disabled');
						$("#div_load").hide();
						alert('请先做好系统配置！');
						return;
					}

				    var mail_list=make_mail_list(sheet1,vals.userinfo.data);
				    var mail_datas=get_mail_data(sheet1,mail_list,vals.serverinfo.email);
				    var mail_prop=create_server_porp(vals.serverinfo);
				    var smtpTransport = nodemailer.createTransport("SMTP",mail_prop);
				   
				    var tby=$("#maintab>tbody>tr");
				    var chk_fun=check_finish(mail_datas.length,smtpTransport);

				    for (var i = 0; i <mail_datas.length; i++) {
				   		var item=mail_datas[i];
				   		var msg_td=tby.eq(item.idx).find("td:last");
				   		sendOneEmail(item,smtpTransport,msg_td,chk_fun);
				    };

				});
			}
		});

		//发送个数
		var count_num=0;
		function check_finish(len,smtpTransport){
			count_num=0;
			return function(){
				count_num++;
				if(count_num==len){
					smtpTransport.close();
					$("#btn_send").toggleClass('disabled');
					$("#div_load").hide();
				}
			}
		}

		function sendOneEmail(item,smtpTransport,td,chk_fun){
			if(item.has_email){
				
				smtpTransport.sendMail(item.mail_option, function(error, response){
				    if(error){
				        td.html(msg.warn("发送失败！"));
				    }else{
				        td.html(msg.suce("发送成功！"));
				    }
				    chk_fun();
				});
			}else{
				td.html(msg.impt("无邮件！"));
				 chk_fun();
			}
		}

		var msg={
			suce:function(msg){
				var span=$('<span>');
				span.text(msg).addClass('label label-success');
				return span;
			},
			warn:function(msg){
				var span=$('<span>');
				span.text(msg).addClass('label label-warning');
				return span;
			},
			impt:function(msg){
				var span=$('<span>');
				span.text(msg).addClass('label label-important');
				return span;
			}

		}


		function xlsworker(data, cb) {
			var worker = new Worker('lib/xls/xlsworker.js');
			worker.onmessage = function(e) {
				switch(e.data.t) {
					case 'ready': break;
					case 'e': console.error(e.data.d);
					case 'xls': cb(e.data.d); break;
				}
			};
			worker.postMessage(data);
		}

		function to_array(workbook) {
			var result = [];
			workbook.SheetNames.forEach(function(sheetName) {
				var array = XLS.utils.sheet_to_array(workbook.Sheets[sheetName]);
				if(array.length > 0){
					result=array
				}
			});
			return result;
		}


		var sheet1={};//excel的数据


		//渲染数据
		function rander_table(){
			$("#title").html(sheet1.title);
			var tr=$("<tr>");
			for(var i in sheet1.col){
				var th=$("<th>").text(sheet1.col[i]);
				tr.append(th);
			}
			tr.append($("<th>").text("信息").width(100));
			$("#maintab>thead").html(tr);
			var tbody=$("#maintab>tbody");
			tbody.empty();
			for(var i in sheet1.data){
				var dt=sheet1.data[i];
				var tr=$("<tr>");
				for(var j in dt){
					var td=$("<td>").text(dt[j]);
					tr.append(td);
				}
				tr.append($("<td>"));
				tbody.append(tr);
			}
		}


		function process_wb(wb) {
			if(typeof Worker !== 'undefined') XLS.SSF.load_table(wb.SSF);
			var array = to_array(wb);
			if(array){
				sheet1.title=array[0][0];
				sheet1.col=array[1];
				array.shift();
				array.shift();
				sheet1.data=array;

				rander_table();
				$("#btn_send").removeClass('disabled');
			}

		}

		var drop = document.getElementById('drop_div');
		function handleDrop(e) {
			e.stopPropagation();
			e.preventDefault();
			if($("#div_load").is(":visible")) return;
			var files = e.dataTransfer.files;
			var i,f;
			for (i = 0, f = files[i]; i != files.length; ++i) {
				var reader = new FileReader();
				var name = f.name;
				reader.onload = function(e) {
					var data = e.target.result;
					if(typeof Worker !== 'undefined') {
						xlsworker(data, process_wb);
					} else {
						var cfb = XLS.CFB.read(data, {type: 'binary'});
						var wb = XLS.parse_xlscfb(cfb);
						process_wb(wb);
					}
				};
				reader.readAsBinaryString(f);
			}
		}

		function handleDragover(e) {
			e.stopPropagation();
			e.preventDefault();
			e.dataTransfer.dropEffect = 'copy';
		}

		if(drop.addEventListener) {
			drop.addEventListener('dragenter', handleDragover, false);
			drop.addEventListener('dragover', handleDragover, false);
			drop.addEventListener('drop', handleDrop, false);
		}



	})
	</script>

	<div id='div_load' class="spinner hide">
	  <div class="rect1"></div>
	  <div class="rect2"></div>
	  <div class="rect3"></div>
	  <div class="rect4"></div>
	  <div class="rect5"></div>
	</div>
	<style type="text/css">
	.spinner {
	  position:absolute;
	  top:125px;
	  right:80px;
	  width: 50px;
	  height: 60px;
	  text-align: center;
	  font-size: 10px;
	}
	 
	.spinner > div {
	  background-color: #0088cc;
	  height: 100%;
	  width: 6px;
	  display: inline-block;
	   
	  -webkit-animation: stretchdelay 1.2s infinite ease-in-out;
	  animation: stretchdelay 1.2s infinite ease-in-out;
	}
	 
	.spinner .rect2 {
	  -webkit-animation-delay: -1.1s;
	}
	 
	.spinner .rect3 {
	  -webkit-animation-delay: -1.0s;
	}
	 
	.spinner .rect4 {
	  -webkit-animation-delay: -0.9s;
	}
	 
	.spinner .rect5 {
	  -webkit-animation-delay: -0.8s;
	}
	 
	@-webkit-keyframes stretchdelay {
	  0%, 40%, 100% { -webkit-transform: scaleY(0.4) }  
	  20% { -webkit-transform: scaleY(1.0) }
	}
	 
	@keyframes stretchdelay {
	  0%, 40%, 100% { 
	    transform: scaleY(0.4);
	    -webkit-transform: scaleY(0.4);
	  }  20% { 
	    transform: scaleY(1.0);
	    -webkit-transform: scaleY(1.0);
	  }
	}
	</style>
    
  </body>
</html>